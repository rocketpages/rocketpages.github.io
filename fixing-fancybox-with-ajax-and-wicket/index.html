
<!DOCTYPE html>
<html>

    <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Kevin Webber</title>
    <link rel="stylesheet" href="/css/uikit.min.css">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="/css/components/slideshow.min.css">
    <script src="/js/jquery-2.2.1.min.js"></script>
    <script src="/js/uikit.min.js"></script>      
    <script src="/js/components/slideshow.min.js"></script>
</head>

    <body>
        <div class="uk-container uk-container-center uk-margin-top uk-margin-large-bottom">

            <nav class="uk-navbar uk-margin-large-bottom">
    <a class="uk-navbar-brand uk-hidden-small" href="/">
        Kevin Webber
    </a>
    <ul class="uk-navbar-nav uk-hidden-small">
        <li>
            <a href="/articles">Articles</a>
        </li>
        <li>
            <a href="/blog">Blog</a>
        </li>
        <li>
            <a href="/videos">Videos</a>
        </li>
        <li>
            <a href="/webinars">Webinars</a>
        </li>                
        <li>
            <a href="/resume">Resume</a>
        </li>
    </ul>
    <a href="#offcanvas" class="uk-navbar-toggle uk-visible-small" data-uk-offcanvas></a>
    <div class="uk-navbar-brand uk-navbar-center uk-visible-small">Kevin Webber</div>
</nav>

            <div class="uk-grid" data-uk-grid-margin>
                <div class="uk-width-medium-2-3">
                    
                    <div class="uk-panel uk-panel-box">
                        <ul class="uk-breadcrumb">
                            <li><a href="/">Home</a></li>
                            <li><a href="/blog">Blog</a></li>
                            <li class="uk-active"><span>Fixing Fancybox with AJAX (and Wicket)</span></li>
                        </ul>
                    </div>
                    
                    <h1>Fixing Fancybox with AJAX (and Wicket)</h1>
                    <p class="uk-text-muted">2010-12-28</p>
                    <p>A personal project I&rsquo;m working on uses the jQuery <a class="offsite-link-inline" href="http://fancybox.net" target="_blank">Fancybox</a> library to display images. It&rsquo;s a great lightbox, except for one small problem: AJAX refreshes break it.</p>

<p>A page I&rsquo;m working on accepts multiple image uploads. Once the images are successfully processed asynchronously on the server, an image panel on the same page is automatically refreshed. The AJAX callback works fine and updates the panel view with the newly uploaded photos, but the net result is that Fancybox stops working completely.</p>

<p>The solution is pretty simple: Fancybox needs to be re-initialized after the view is refreshed. This involves invoking a JavaScript function <em>after</em> the AJAX callback completes. Fortunately, I&rsquo;m using Wicket, which makes invoking JavaScript after the callback a breeze.</p>

<p>Here&rsquo;s the (condensed version of) code for my behavior class that handles the repainting, callback, and post-callback JS invocation:</p>

<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span></span><span style="color: #000080; font-weight: bold">final</span> IBehavior repaintBehavior = <span style="color: #000080; font-weight: bold">new</span> AbstractDefaultAjaxBehavior() {
	@Override
	<span style="color: #000080; font-weight: bold">protected</span> <span style="color: #000080; font-weight: bold">void</span> respond(AjaxRequestTarget target)
	{
		ThingModel thingModel = <span style="color: #000080; font-weight: bold">new</span> ThingModel(thingId);
		UnprocessedPhotosModel photosModel = <span style="color: #000080; font-weight: bold">new</span> UnprocessedPhotosModel(getCurrentUser().<span style="color: #FF0000">getId</span>(), tokenId);
		List photos = photosModel.<span style="color: #FF0000">getObject</span>();

		<span style="color: #000080; font-weight: bold">for</span> (Photo photo : photos)
		{
			photo.<span style="color: #FF0000">setThing</span>(thingModel.<span style="color: #FF0000">getObject</span>());
			ServiceFactory.<span style="color: #FF0000">getPhotoService</span>().<span style="color: #FF0000">savePhoto</span>(photo);
		}

		target.<span style="color: #FF0000">addComponent</span>(photosPanel);
		target.<span style="color: #FF0000">appendJavascript</span>(<span style="color: #0000FF">&quot;$.fancyboxResetBusy(); reinitFancybox();&quot;</span>);
	}

	@Override
	<span style="color: #000080; font-weight: bold">public</span> <span style="color: #000080; font-weight: bold">void</span> renderHead(IHeaderResponse response)
	{
		<span style="color: #000080; font-weight: bold">super</span>.<span style="color: #FF0000">renderHead</span>(response);
		CharSequence callback = getCallbackScript();
		response.<span style="color: #FF0000">renderJavascript</span>(<span style="color: #0000FF">&quot;function uploadCompleted() { &quot;</span> + callback + <span style="color: #0000FF">&quot;}&quot;</span>, <span style="color: #0000FF">&quot;customUploadCompleted&quot;</span>);
	}
};
</pre></div>


<p>For those who aren&rsquo;t familiar with Wicket, the <strong>renderHead</strong> method is rendering a custom JavaScript function in the view. The multiple upload Flash component I use invokes the rendered JS function after it finishes processing the images. When the Flash uploader invokes <strong>uploadCompleted</strong>, Wicket handles all the AJAX plumbing and executes the Java code in the <strong>respond</strong> method above.</p>

<p>The two most important lines of code are the calls to <em><strong>target</strong></em>. <em>target.addComponent</em> instructs Wicket to refresh the photo panel, and <em>target.appendJavascript</em> instructs Wicket to invoke the functions in the String parameter after the panel is refreshed.</p>

<p>Let&rsquo;s take a look at the <strong>reinitFancybox</strong> JS function which gets invoked after the panel is refreshed.
<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span></span><span style="color: #000080; font-weight: bold">function</span> reinitFancybox() {    
    <span style="color: #008800; font-style: italic">// CSS</span>
    $(<span style="color: #0000FF">&quot;.gallery img, portfolio.list img, .portfolio.grid-2 div img, a.fancy, ul.screens img&quot;</span>).css(<span style="color: #0000FF">&quot;opacity&quot;</span>, <span style="color: #0000FF">&quot;1&quot;</span>);

    <span style="color: #008800; font-style: italic">// ON MOUSE OVER</span>
    $(<span style="color: #0000FF">&quot;.gallery img, .portfolio-list img, .portfolio.grid-2 div img, a.fancy, ul.screens img&quot;</span>).hover(<span style="color: #000080; font-weight: bold">function</span> () {
        <span style="color: #008800; font-style: italic">// SET OPACITY TO 100%</span>
        $(<span style="color: #000080; font-weight: bold">this</span>).stop().animate({opacity: <span style="color: #0000FF">0.5</span>}, <span style="color: #0000FF">&quot;fast&quot;</span>);
    },
    <span style="color: #008800; font-style: italic">// ON MOUSE OUT</span>
    <span style="color: #000080; font-weight: bold">function</span> () {
        <span style="color: #008800; font-style: italic">// SET OPACITY BACK TO 100%</span>
        $(<span style="color: #000080; font-weight: bold">this</span>).stop().animate({opacity: <span style="color: #0000FF">1</span>}, <span style="color: #0000FF">&quot;fast&quot;</span>);
    });
    <span style="color: #008800; font-style: italic">// INIT FANCYBOX</span>
    $(<span style="color: #0000FF">&quot;li.image a, a.fancy, .portfolio.grid li a.folio-zoom, .portfolio-list.image a&quot;</span>).fancybox({
        <span style="color: #0000FF">&#39;titlePosition&#39;</span>     : <span style="color: #0000FF">&#39;over&#39;</span>
    });
}
</pre></div>
</p>

<p>Most of the code above re-initializes the CSS hover effects I use to pretty up my image panel. The last piece is responsible for re-initializing Fancybox itself. <em>At this point, we should be done, Fancybox should work perfectly again.</em> But there&rsquo;s a small catch, the Fancybox script includes a global variable named <strong>busy</strong> which is set to <em>true </em>at the beginning of almost every single function. If for any reason the script is interrupted before busy is set back to <em>false, </em>re-initialization will always abort. Here&rsquo;s a snippet of the Fancybox code below:</p>

<p><div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span></span>$.fancybox = <span style="color: #000080; font-weight: bold">function</span>(obj) {
	<span style="color: #000080; font-weight: bold">if</span> (busy) {
		<span style="color: #000080; font-weight: bold">return</span>;
	}

	busy = <span style="color: #000080; font-weight: bold">true</span>;

	<span style="color: #008800; font-style: italic">// ...</span>
};
</pre></div>
</p>

<p>It&rsquo;s pretty obvious that if busy is <em>true</em> Fancybox won&rsquo;t initialize. We need to make sure busy is set to false before attempting to re-initialize. Unfortunately, this requires a small <span style="text-decoration: line-through;">kludge</span> addition to the Fancybox script itself. I&rsquo;ve added the following public function:</p>

<p><div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span></span>$.fancyboxResetBusy = <span style="color: #000080; font-weight: bold">function</span>() {
	busy = <span style="color: #000080; font-weight: bold">false</span>;
}
</pre></div>
</p>

<p>Invoking this before the initialize function ensures the initialization doesn&rsquo;t return prematurely.</p>

                </div>
            </div>
            
            <hr class="uk-grid-divider">
            
<div class="uk-grid uk-text-muted uk-text-small" data-uk-grid-margin>

    <div class="uk-width-medium-1-2">
        <h5>Interested in meeting?</h5>
        <p>I organize a few local groups for programmers in the Toronto area. If you'd like to meet in person, feel free to come out to one of these events.</p>

        <ul>
            <li><a href="http://www.meetup.com/Reactive-TO/">ReactiveTO</a></li>
            <li><a href="http://www.meetup.com/Programming-Book-Club-Toronto/">Programming Book Club Toronto</a></li>
        </ul>
    </div>

    <div class="uk-width-medium-1-2">
        <h5>Interested in chatting?</h5>
        <p>I'm located in <strong>Toronto, Canada</strong>. If you're interested in learning more about anything I've published and would like to meet via Skype or have a coffee in Toronto, feel free to contact me at one of the links below.</p>
        <p><i class="fa fa-paper-plane"></i> <a href="http://goo.gl/forms/Ox9cGw4Ohw" target="_blank">Email</a></p>
        <p><i class="fa fa-linkedin-square"></i> <a href="https://ca.linkedin.com/in/kvnwbbr">LinkedIn</a></p>
        <p><i class="fa fa-twitter-square"></i> <a href="https://twitter.com/kvnwbbr">Twitter</a></p>
    </div>

</div>

        </div>    

        <div id="offcanvas" class="uk-offcanvas">
    <div class="uk-offcanvas-bar">
        <ul class="uk-nav uk-nav-offcanvas">
            <li>
                <a href="/">Home</a>
            </li>
            <li>
                <a href="/articles">Articles</a>
            </li>
            <li>
                <a href="/blog">Blog</a>
            </li>
            <li>
                <a href="/videos">Videos</a>
            </li>
            <li>
                <a href="/webinars">Webinars</a>
            </li>                
            <li>
                <a href="/resume">Resume</a>
            </li>
        </ul>
    </div>
</div>
        
    </body>
    
</html>