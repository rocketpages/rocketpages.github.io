<!DOCTYPE html>
<html>

    <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Kevin Webber</title>
    <link rel="stylesheet" href="/css/uikit-3.0.0.19.min.css">
    <link rel="stylesheet" type="text/css" href="https://cloud.typography.com/6521356/7819972/css/fonts.css" />
    <script
          src="https://code.jquery.com/jquery-3.2.1.min.js"
          integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
          crossorigin="anonymous"></script>
    <script src="/js/uikit-3.0.0.19.min.js"></script>      
    <script src="/js/uikit-3.0.0.19-icons.min.js"></script>      
</head>

<style>
    
    body {
        color: #222;
        font-family: "Whitney SSm A", "Whitney SSm B";
        font-style: normal;
        font-weight: 400;
    }
    
    .uk-text-lead {
        font-family: "Ringside Regular SSm A", "Ringside Regular SSm B";
        font-style: normal;
        font-weight: 400;
    }
    
    p {
        font-size: 1em;
        line-height: 150%;
    }
    
    a {
        color: #3498db;
    }
    
    nav, .uk-navbar-nav>li>a {
        font-weight: 400;
        font-size: 1em;
        color: #222;
    }
        
    h1, h2, h3, h4, h5 {
        color: #222;
    }
    
    h1 {
        font-family: "Ringside Regular SSm A", "Ringside Regular SSm B";
        font-size: 2.5em;
        letter-spacing: -1px;
    }
    
    h2 {
        font-family: "Ringside Regular SSm A", "Ringside Regular SSm B";
        font-size: 1.7em;
    }
    
    h3 {
        font-family: "Whitney SSm A", "Whitney SSm B";
        font-size: 1.5em;
    }
    
    h4 {
        font-family: "Whitney SSm A", "Whitney SSm B";
        font-size: 1.3em;
    }
    
    h5 {
        font-family: "Whitney SSm A", "Whitney SSm B";
        font-size: 1em;
    }
    
    pre {
        font-family: "Operator Mono SSm A", "Operator Mono SSm B";
        font-style: normal;
        font-size: 0.85em;
    }
    
    #kevin-webber {
        font-family: "Operator Mono SSm A", "Operator Mono SSm B";
        font-style: italic;
        font-weight: 700;
        letter-spacing: -3px;
    }

    #latest-content {
        font-size: 0.85em;
    }

    .uk-section-primary {
        background-color: #2980b9;
    }

    #video-li h2, #video-li h5, #video-li p {
        margin-top: 0px;
        margin-bottom: 8px;
    }

    #video-li h2 {
        margin-top: 18px;
    }

    #footer {
        font-size: 0.85em;
    }
    
    .uk-card-secondary, .uk-section-secondary {
        background: #34495e;
        font-size:0.8em;
    }
    
    #blog-post h1 {
        margin-top: 1em;
        margin-bottom: 10px;
    }
    
    #blog-post h4 {
        margin-bottom: 0px;
    }
    
    #blog-post h4.date {
        font-size:1em;
        font-style: italic;
        margin-top: 0px;
        margin-bottom: 2em;
        font-family: "Operator Mono SSm A", "Operator Mono SSm B";
        color:#7f8c8d;
    }
        
    .blog-post {
        margin-bottom:2.5em;
    }
    
    #blog-post .uk-active span {
        font-weight: 700;
    }
    
    .blog-post h5 {
        font-weight: 700;
        font-size: 0.8em;
        color:#34495e;
        font-family: "Ringside Regular SSm A", "Ringside Regular SSm B";
        margin-bottom:2px;
    }
    
    .blog-post h2 {
        margin-top:0px;
        margin-bottom:0px;
        padding-left:0px;
    }
    
    .blog-post p {
        margin-top:4px;
        margin-bottom:0px;
    }
    
    .pub-post {
        margin-bottom:2.5em;
    }
    
    .pub-post h5 {
        font-weight: 700;
        font-size: 0.8em;
        color:#34495e;
        font-family: "Ringside Regular SSm A", "Ringside Regular SSm B";
        margin-bottom:5px;
    }
    
    .pub-post h4 {
        margin-top:0px;
        margin-bottom:0px;
    }
    
    .pub-post p {
        margin-top:5px;
        margin-bottom:0px;
    }

    .photo-overlay {
        font-size: 0.85em;
    }
    
    .video-listing h2 {
        margin-top:1em;
        margin-bottom:0px;
    }
    
    .video-listing h5 {
        margin-top: 1em;
        margin-bottom: 0px;
        font-weight: 700;
        font-size: 0.8em;
        color:#34495e;
        font-family: "Ringside Regular SSm A", "Ringside Regular SSm B";       
    }
    
    .video-listing p {
        margin-top: 0px;
    }
    
    .uk-text-lead {        
        font-family: "Whitney SSm A", "Whitney SSm B";
    }
    
    .talk-title-small .title {
        font-weight: 700;
        font-family: "Ringside Regular SSm A", "Ringside Regular SSm B";   
        font-size: 1.1em;
    }
    
    .talk-title-small .link {
        padding-left:6px;
    }
    
</style>

<script>

    $(document).ready(function() {        
        $(".video").each(function() {
            
            $(this).append($('<div/>', {'class': 'play'}));

            $(document).delegate('#'+this.id, 'click', function() {
                
                var iframe_url = $(this).attr("iframe-src");

                
                var iframe = $('<iframe></iframe>', {'frameborder': '0', 'src': iframe_url, 'width': $(this).width(), 'height': $(this).height() })

                
                $(this).replaceWith(iframe);
            });
        });
    });
    
</script>

    <body>
        
        <nav class="uk-navbar-container uk-margin-bottom-remove uk-visible@m" uk-navbar>
    <div class="uk-navbar-center">
        <a class="uk-navbar-item uk-logo" href="/" uk-icon="icon: home"></a>
        <ul class="uk-navbar-nav">
            <li><a href="/blog">Blog</a></li>
            <li><a href="/video">Videos</a></li>
            <li><a href="/talk">Talks</a></li>            
            <li><a href="/resume">Resume</a></li>
        </ul>
    </div>
</nav>

<nav class="uk-navbar-container uk-hidden@m" uk-navbar>
    <div class="uk-navbar-left">
        <a class="uk-navbar-item uk-logo" href="/"><img style="height:35px;"/></a>
    </div>
    <div class="uk-navbar-right">        
        <a class="uk-navbar-toggle uk-hidden@m" uk-navbar-toggle-icon uk-toggle href="#offcanvas-nav"></a>        
    </div>
</nav>

<div id="offcanvas-nav" uk-offcanvas="overlay: true">
    <div class="uk-offcanvas-bar">
        <ul class="uk-nav uk-nav-default">
            <li><a href="/">Home</a></li>
            <li><a href="/blog">Blog</a></li>
            <li><a href="/video">Videos</a></li>
            <li><a href="/talk">Talks</a></li>            
            <li><a href="/resume">Resume</a></li>
        </ul>
    </div>
</div>

        <div id="blog-post" class="uk-section uk-padding-large uk-section-default">
            <div class="uk-container uk-container-small">            
                    <div class="uk-tile uk-tile-muted uk-padding-small" uk-sticky>                        
                        <ul class="uk-breadcrumb">
                            <li><a class="uk-logo" href="/" uk-icon="icon: home"></a></li>
                            <li><a href="/blog">Blog</a></li>
                            <li class="uk-active"><span>Fixing Fancybox with AJAX (and Wicket)</span></li>
                        </ul>
                    </div>                    
                
                    <h1>Fixing Fancybox with AJAX (and Wicket)</h1>
                    <h4 class="uk-heading-bullet date">December 28, 2010</h4>
                    <p>A personal project I&rsquo;m working on uses the jQuery <a href="http://fancybox.net" title="Fancybox">Fancybox</a> library to display images. It&rsquo;s a great lightbox, except for one small problem: AJAX refreshes break it.</p>

<p>A page I&rsquo;m working on accepts multiple image uploads. Once the images are successfully processed asynchronously on the server, an image panel on the same page is automatically refreshed. The AJAX callback works fine and updates the panel view with the newly uploaded photos, but the net result is that Fancybox stops working completely.</p>

<p>The solution is pretty simple: Fancybox needs to be re-initialized after the view is refreshed. This involves invoking a JavaScript function <em>after</em> the AJAX callback completes. Fortunately, I&rsquo;m using Wicket, which makes invoking JavaScript after the callback a breeze.</p>

<p>Here&rsquo;s the (condensed version of) code for my behavior class that handles the repainting, callback, and post-callback JS invocation:</p>

<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span></span><span style="color: #000080; font-weight: bold">final</span> IBehavior repaintBehavior = <span style="color: #000080; font-weight: bold">new</span> AbstractDefaultAjaxBehavior() {
	@Override
	<span style="color: #000080; font-weight: bold">protected</span> <span style="color: #000080; font-weight: bold">void</span> respond(AjaxRequestTarget target)
	{
	    ThingModel thingModel = <span style="color: #000080; font-weight: bold">new</span> ThingModel(thingId);
	    UnprocessedPhotosModel photosModel = <span style="color: #000080; font-weight: bold">new</span> UnprocessedPhotosModel(getCurrentUser().<span style="color: #FF0000">getId</span>(), tokenId);
	    List photos = photosModel.<span style="color: #FF0000">getObject</span>();
	
	    <span style="color: #000080; font-weight: bold">for</span> (Photo photo : photos)
	    {
	        photo.<span style="color: #FF0000">setThing</span>(thingModel.<span style="color: #FF0000">getObject</span>());
	        ServiceFactory.<span style="color: #FF0000">getPhotoService</span>().<span style="color: #FF0000">savePhoto</span>(photo);
	    }
	
	    target.<span style="color: #FF0000">addComponent</span>(photosPanel);
	    target.<span style="color: #FF0000">appendJavascript</span>(<span style="color: #0000FF">&quot;$.fancyboxResetBusy(); reinitFancybox();&quot;</span>);
	}
	
	@Override
	<span style="color: #000080; font-weight: bold">public</span> <span style="color: #000080; font-weight: bold">void</span> renderHead(IHeaderResponse response)
	{
	    <span style="color: #000080; font-weight: bold">super</span>.<span style="color: #FF0000">renderHead</span>(response);
	    CharSequence callback = getCallbackScript();
	    response.<span style="color: #FF0000">renderJavascript</span>(<span style="color: #0000FF">&quot;function uploadCompleted() { &quot;</span> + callback + <span style="color: #0000FF">&quot;}&quot;</span>, <span style="color: #0000FF">&quot;customUploadCompleted&quot;</span>);
	}
};
</pre></div>


<p>For those who aren&rsquo;t familiar with Wicket, the <strong>renderHead</strong> method is rendering a custom JavaScript function in the view. The multiple upload Flash component I use invokes the rendered JS function after it finishes processing the images. When the Flash uploader invokes <strong>uploadCompleted</strong>, Wicket handles all the AJAX plumbing and executes the Java code in the <strong>respond</strong> method above.</p>

<p>The two most important lines of code are the calls to <em>target</em>. <em>target.addComponent</em> instructs Wicket to refresh the photo panel, and <em>target.appendJavascript</em> instructs Wicket to invoke the functions in the String parameter after the panel is refreshed.</p>

<p>Let&rsquo;s take a look at the <strong>reinitFancybox</strong> function which gets invoked after the panel is refreshed.</p>

<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span></span><span style="color: #000080; font-weight: bold">function</span> reinitFancybox() {  
    <span style="color: #008800; font-style: italic">// CSS</span>
	$(<span style="color: #0000FF">&quot;.gallery img, portfolio.list img, .portfolio.grid-2 div img, a.fancy, ul.screens img&quot;</span>).css(<span style="color: #0000FF">&quot;opacity&quot;</span>, <span style="color: #0000FF">&quot;1&quot;</span>);
	
	<span style="color: #008800; font-style: italic">// ON MOUSE OVER</span>
	$(<span style="color: #0000FF">&quot;.gallery img, .portfolio-list img, .portfolio.grid-2 div img, a.fancy, ul.screens img&quot;</span>).hover(<span style="color: #000080; font-weight: bold">function</span> () {
	    <span style="color: #008800; font-style: italic">// SET OPACITY TO 100%</span>
	    $(<span style="color: #000080; font-weight: bold">this</span>).stop().animate({opacity: <span style="color: #0000FF">0.5</span>}, <span style="color: #0000FF">&quot;fast&quot;</span>);
	},
	<span style="color: #008800; font-style: italic">// ON MOUSE OUT</span>
	<span style="color: #000080; font-weight: bold">function</span> () {
	    <span style="color: #008800; font-style: italic">// SET OPACITY BACK TO 100%</span>
	    $(<span style="color: #000080; font-weight: bold">this</span>).stop().animate({opacity: <span style="color: #0000FF">1</span>}, <span style="color: #0000FF">&quot;fast&quot;</span>);
	});
	<span style="color: #008800; font-style: italic">// INIT FANCYBOX</span>
	$(<span style="color: #0000FF">&quot;li.image a, a.fancy, .portfolio.grid li a.folio-zoom, .portfolio-list.image a&quot;</span>).fancybox({
	    <span style="color: #0000FF">&#39;titlePosition&#39;</span>     : <span style="color: #0000FF">&#39;over&#39;</span>
	});
}
</pre></div>


<p>Most of the code above re-initializes the CSS hover effects I use to pretty up my image panel. The last piece is responsible for re-initializing Fancybox itself. <em>At this point, we should be done, Fancybox should work perfectly again.</em> But there&rsquo;s a small catch, the Fancybox script includes a global variable named <strong>busy</strong> which is set to <em>true </em>at the beginning of almost every single function. If for any reason the script is interrupted before busy is set back to <em>false, </em>re-initialization will always abort. Here&rsquo;s a snippet of the Fancybox code below:</p>

<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span></span>$.fancybox = <span style="color: #000080; font-weight: bold">function</span>(obj) {
	<span style="color: #000080; font-weight: bold">if</span> (busy) {
	    <span style="color: #000080; font-weight: bold">return</span>;
	}
	
	busy = <span style="color: #000080; font-weight: bold">true</span>;
	
	<span style="color: #008800; font-style: italic">// ...</span>
};
</pre></div>


<p>It&rsquo;s pretty obvious that if busy is <em>true</em> Fancybox won&rsquo;t initialize. We need to make sure busy is set to false before attempting to re-initialize. Unfortunately, this requires a small <span style="text-decoration: line-through;">kludge</span> addition to the Fancybox script itself. I&rsquo;ve added the following public function:</p>

<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%"><span></span>$.fancyboxResetBusy = <span style="color: #000080; font-weight: bold">function</span>() {
	busy = <span style="color: #000080; font-weight: bold">false</span>;
}
</pre></div>


<p>Invoking this before the initialize function ensures the initialization doesn&rsquo;t return prematurely.</p>

            </div>
        </div>    
        
        <div id="footer" class="uk-section uk-padding-large uk-margin-remove uk-section-secondary">
    <div class="uk-container">
        <div uk-grid>
            <div class="uk-width-1-2@m uk-text-left uk-text-center@m">
                <a href="https://redelastic.com"><img style="width:350px" src="https://res.cloudinary.com/dxqjvpa0t/image/upload/v1491487727/redelastic-footer_ohmbb5.png"/></a>
            </div>
            <div class="uk-width-1-2@m">
                <p>RedElastic is a boutique consulting firm based out of Toronto, Canada, that specializes in applying the principles of distributed computing to enterprise systems analysis and development.</p>
                <a class="uk-button uk-button-default uk-margin-small-top" href="https://redelastic.com/contact">Get in touch</a>   
            </div>
        </div>             
    </div>
</div>
        
    </body>
    
</html>